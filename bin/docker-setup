#!/usr/bin/env bash
# Docker setup script for Blog
# This script helps new developers get started with Docker quickly

set -e

echo "üê≥ Blog Docker Setup"
echo "=========================="
echo ""

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
  echo "‚ùå Error: Docker is not running"
  echo "Please start Docker Desktop and try again"
  exit 1
fi

echo "‚úÖ Docker is running"
echo ""

# Check if .env exists
if [ ! -f .env ]; then
  echo "‚ùå Error: .env file not found"
  echo ""
  echo "Please create a .env file with the following content:"
  echo ""
  echo "JOB_CONCURRENCY=1"
  echo "RAILS_MAX_THREADS=5"
  echo "SOLID_QUEUE_IN_PUMA=true"
  echo "TAILWINDCSS_IN_PUMA=true"
  echo ""
  echo "Ask a team member for the actual API key values"
  exit 1
fi

echo "‚úÖ .env file found"
echo ""

# Check if docker-compose.yml exists
if [ ! -f docker-compose.yml ]; then
  echo "‚ùå Error: docker-compose.yml not found"
  exit 1
fi

echo "‚úÖ docker-compose.yml found"
echo ""

# Ask if user wants to clean start
echo "Do you want to start fresh (removes existing containers and volumes)? [y/N]"
read -r response
if [[ "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
  echo "üßπ Cleaning up existing containers and volumes..."
  docker-compose down -v
  echo "‚úÖ Cleanup complete"
  echo ""
fi

# Build and start services
echo "üî® Building Docker images (this may take a few minutes)..."
docker-compose build

echo ""
echo "üöÄ Starting services..."
docker-compose up -d

echo ""
echo "‚è≥ Waiting for database to be ready..."
sleep 5

# Check if services are running
if ! docker-compose ps | grep -q "Up"; then
  echo "‚ùå Error: Services failed to start"
  echo "Check logs with: docker-compose logs"
  exit 1
fi

echo "‚úÖ Services are running"
echo ""

# Setup database
echo "üìä Setting up database..."
if docker-compose exec -T web bin/rails db:create; then
  echo "‚úÖ Database created"
else
  echo "‚ÑπÔ∏è  Database already exists (this is fine)"
fi

echo ""
echo "üîÑ Running migrations..."
docker-compose exec -T web bin/rails db:migrate

echo ""
echo "üå± Loading seed data..."
docker-compose exec -T web bin/rails db:seed

echo ""
echo "=========================================="
echo "‚ú® Setup Complete!"
echo "=========================================="
echo ""
echo "Your Blog development environment is ready!"
echo ""
echo "üìç Access the application at: http://localhost:3000"
echo "üìç PostgreSQL is running on: localhost:5432"
echo ""
echo "Useful commands:"
echo "  View logs:        docker-compose logs -f web"
echo "  Rails console:    docker-compose exec web bin/rails console"
echo "  Run tests:        docker-compose exec web bundle exec rspec"
echo "  Stop services:    docker-compose down"
echo "  Restart services: docker-compose restart"
echo ""
echo "üìö For more information, see:"
echo "  - DOCKER.md (complete Docker documentation)"
echo "  - DOCKER_SETUP_SUMMARY.md (quick reference)"
echo ""
